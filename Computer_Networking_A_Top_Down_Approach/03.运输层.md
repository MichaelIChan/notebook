运输层为运行在不同主机上的应用进程提供直接的通信服务。<br>
# 3.1 概述和运输层服务
在发送端，运输层将从发送应用程序进程接收到的报文转换成运输层分组，即运输层报文段。然后，运输层将这些报文段传递给网络层，网络层将其封装成网络层分组（即数据报）并向目的地发送。<br>
在接收端，网络层从数据报中提取运输层报文段，并将该报文段向上交给运输层。运输层则处理接收到的报文段，使该报文段中的数据为接收应用程序使用。<br>
需要注意：网络路由器仅作用与该数据报的网络层字段，即它们不检查封装在该数据报的运输层报文段的字段。<br>
## 3.1.1 运输层和网络层的关系
在协议栈中，运输层位于网络层之上。网络层提供了主机之间的逻辑通信，运输层为运行在不同主机上的进程之间提供了逻辑通信。<br>

运输层协议只工作在端系统中。在端系统中，运输层协议将来自应用进程的报文移动到网络边缘（即网络层），反过来也是一样，但对有关这些报文在网络核心如何移动并不作任何规定。中间路由器既不处理也不识别运输层加在应用层报文的任何信息。<br>

运输协议能够提供的服务常常受制于底层网络层协议的服务模型。如果网络层协议无法为主机之间发送的运输层报文提供时延或带宽保证的话，运输层协议也就无法为进程之间发送的应用程序报文提供时延或带宽保证。<br>

然而，即使底层网络协议不能在网络层提供相应的服务，运输层协议也能提供某些服务。例如，网络层协议是不可靠的，但运输层协议能为应用程序提供可靠的数据传输服务。即使网络层不能保证运输层报文段的机密性，运输层协议可以使用加密来确保应用程序报文不被他人读取。<br>

## 3.1.2 因特网运输层概述
UDP（用户数据报协议）为调用它的应用程序提供一种不可靠、无连接的服务。<br>
TCP（传输控制协议）为调用它的应用程序提供一种可靠的、面向连接的服务。<br>

因特网网络层有一个协议叫IP，即网际协议。IP为主机之间提供了逻辑通信。IP的服务模型是尽力而为交付服务，即不确保报文段的交付，不保证报文段的按序交付，不保证报文段中数据饿完整性，是不可靠服务。<br>

UDP和TCP最基本的责任是，将两个端系统间IP的交付服务扩展为运行在端系统上的两个进程之间的交付服务。将主机间交付扩展到进程间交付被称为运输层的多路复用与多路分解。<br>

# 3.2 多路复用与多路分解
在目的主机，运输层从紧邻其下的网络层接收报文段。运输层负责将这些报文段中的数据交付给在主机上运行的适当应用程序进程。<br>

一个进程（作为网络应用的一部分）有一个或多个套接字（socket），它相当于从网络向进程传递数据和从进程向网络传递数据的门户。因此，在接收主机中的运输层实际上并没有直接将数据交付给进程，而是将数据交给了一个中间的套接字。每个套接字都有唯一的标识符。<br>

将运输层报文段中的数据交付到正确的套接字的工作称为多路分解。在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息从而生成报文段，然后将报文段传递到网络层，所有这些工作称为多路复用。运输层将从其下的网络层收到的报文段分解后交给其上的应用进程，这一过程是通过将到达的报文段数据定向到对应进程的套接字来完成的。<br>
## 3.2.1 无连接的多路复用与多路分解
通常，应用程序的客户端让运输层自动地分配端口号，而服务器端则分配一个特定的端口号。<br>

当客户端要发送一个应用程序数据块给位于服务器端中的另一进程，客户端中的运输层创建一个运输层报文段，其中包括应用程序数据、源端口号、目的端口号和两个其他值。然后运输层将得到的报文段传递到网络层。网络层将该报文段封装到一个IP数据报中，并尽力而为地将报文段交付给服务器端。服务器端运输层检查该报文段中的目的端口号，并将该报文段交付给该端口号所标识的套接字。值得注意的是，服务器端能够运行多个进程，每个进程都有自己的UDP套接字及相应的端口号。<br>

一个UDP套接字是由一个二元组来全面标识的，该二元组包含一个目的IP地址和一个目的端口号。因此，如果两个UDP报文段有不同的源IP地址和/或源端口号，但具有相同的目的IP地址和目的端口号，那么这两个报文段将通过相同的目的套接字被定向到相同的目的进程。<br>
## 3.2.2 面向连接的多路复用与多路分解
TCP套接字和UDP套接字之间的一个细微差别是，TCP套接字是由一个四元组（源IP地址，源端口号，目的IP地址，目的端口号）来标识的。所以，当两个具有不同源IP地址或源端口号的到达TCP报文段将被定向到两个不同的套接字，除非TCP报文端携带了初始创建连接的请求。<br>

服务器主机可以支持很多并行的TCP套接字，每个套接字与一个进程相联系，并由其四元组来标识每个套接字。<br>
## 3.2.3 Web服务器与TCP

# 3.3 无连接运输：UDP
UDP从应用进程得到数据，附加上用于多路复用/分解服务的源和目的端口号字段，以及两个其他的小字段，然后将形成的报文段交给网络层。网络层将该运输层报文段封装到一个IP数据报中，然后尽力而为地尝试将此报文段交付给接收主机。如果该报文段到达接收主机，UDP使用目的端口号将报文段中的数据交付给正确的应用进程。使用UDP发送报文段之前，发送方和接收方的运输层实体之间没有握手，因此UDP被称为是无连接的。<br>

许多应用更适合用UDP，原因主要以下几点：
* 关于何时、发送什么数据的应用层控制更为精细。
* 无需建立连接，不会引入建立连接的时延。
* 无连接状态，不需要维护、跟踪这些参数。
* 分组首部开销小，TCP报文段首部开销20字节，UDP开销为8字节。

## 3.3.1 UDP报文段结构
UDP报文段包含4个首部字段，源端口号，目的端口号，长度和检验和，以及数据字段。应用层数据占用UDP报文段的数据字段。UDP首部每个字段由两个字节组成。通过端口号可以使目的主机将应用数据交给运行在目的端系统中的相应进程。长度字段指示了在UDP报文段中的字节数（首部加数据）。接收方使用检验和来检查在该报文段中是否出现了差错。<br>
## 3.3.2 UDP检验和
检验和用于确定当UDP报文段从源到达目的地移动时，其中的比特是否发生了改变。发送方的UDP对报文段中的所有16比特字的和进行反码运算，求和时遇到的任何溢出都被回卷。得到的结果被放在UDP报文段中的检验和字段。<br>

UDP提供了检验和，其原因是由于不能保证源和目的之间的所有链路都提供差错检测；此外，即使报文段经链路正确地传输，当报文段存储在某台路由器的内存中时，也可能引入比特差错。在既无法确保链路的可靠性，右无法确保内存中的差错检测的情况下，如果端到端数据传输服务要提供差错检测，UDP就必须在端到端基础上在运输层提供差错检测。这是一个在系统设计中被称颂的端到端原则的例子，该原则表述为因为某种功能必须基于端到端实现：“与在较高级别提供这些功能的代价相比，在较低级别上设置的功能可能是冗余或几乎没有价值的。”<br>

虽然UDP提供差错检测，但是对差错恢复无能为力。<br>

# 3.4 可靠数据传输原理
可靠数据传输框架，为上层提供的服务抽象是：数据可以通过一条可靠的新到进行传输。实现这种服务抽象的是可靠数据传输协议的责任。<br>

可靠数据传输机制及其用途的总结：<br>
| 机制        | 用途和说明 |
|   :----:   |    :----:     |
| 检验和      | 用于检测在一个传输分组中的比特错误 |
| 定时器      | 用于超时/重传一个分组，可能因为该分组（或其ACK）在信道中丢失了。由于当一个分组延时但未丢失（过早超时），或当一个分组已被接收方收到但从接收方到发送方的ACK丢失时，可能产生超时事件，所以接收方可能会收到一个分组的多个冗余副本 |
| 序号        | 用于为从发送方流向接收方的数据分组按顺序编号。所接收分组的序号间的空隙可使接收方检测出丢失的分组。具有相同序号的分组可使接收方检测出一个分组的冗余副本 |
| 确认        | 接收方用于告诉发送方一个分组或一组分组已被正确地接收到了。确认报文通常携带着被确认的分组或多个分组的序号。确认可以是逐个的或累积的，这取决于协议 |
| 否定确认    | 接收方用于告诉发送方某个分组未被正确地接收。否定确认报文通常携带着未被正确接收的分组的序号 |
| 窗口、流水线 | 发送方也许被限制仅发送那些序号落在一个指定范围内的分组。通过允许一次发送多个分组但未被确认，发送方的利用率可在停等操作模式的基础上得到增加。窗口长度可根据接收方接收和缓存报文的能力、网络中的拥塞程度或两者情况来进行设置 |

# 3.5 面向连接的运输：TCP

## 3.5.1 TCP连接
TCP连接的组成包括：一台主机上的缓存、变量和与进程连接的套接字，以及另一台主机上的另一组缓存、变量和与进程连接的套接字。在这两台主机之间的网络元素（路由器、交换机和中继器）中，没有为该连接分配任何缓存和变量。<br>

TCP被称为是面向连接的，这是因为在一个应用进程可以开始向另一个应用进程发送数据之前，这两个进程必须先相互“握手”，即它们必须相互发送某些预备报文段，以建立确保数据传输的参数。TCP连接提供的是全双工服务。<br>

一旦建立起一条TCP连接，两个应用进程之间就可以相互发送数据了。客户进程通过套接字传递数据流。TCP将这些数据引导到该连接的发送缓存里，发送缓存是在三次握手初期设置的缓存之一。接下来TCP就会不时的从发送缓存里取出一块数据并发送。TCP可从缓存中取出并放入报文段中的数据数量受限于最大报文段长度（MSS）。MSS通常根据最初确定的由本地发送主机发送的最大链路层帧长度（MTU）来设置。设置该MSS要保证一个TCP报文段（当封装在一个IP数据报中）加上TCP/IP首部长度（通常40字节）将适合单个链路层帧。以太网和PPP链路层协议都具有1500字节的MTU，因此MSS的典型值为1460字节。注意，MSS是指在报文段里应用层数据的最大长度，而不是指包括TCP首部的TCP报文段的最大长度。<br>

TCP为每块客户数据配上一个TCP首部，从而形成多个TCP报文段。这些报文段被下传给网络层，网络层将其分别封装在网络层IP数据报中。然后这些IP数据报被发送到网络中。当TCP在另一端接收到一个数据报后，该报文段的数据就被放入该TCP连接的接收缓存中。应用程序从此缓存中读取数据流。TCP连接每一端都有各自的发送缓存和接收缓存。<br>
## 3.5.2 TCP报文段结构
TCP报文段由首部字段和一个数据字段组成。数据字段包含一块应用数据。MSS限制了报文段数据字段的最大长度。<br>

TCP报文段首部包含源端口号和目的端口号各16比特，它被用于多路复用/分解来自或送到上层应用的数据。TCP首部也包含检验和字段的16比特。TCP报文段首部还包含下列字段：
* 32比特的序号字段和32比特的确认号字段。这些字段被TCP发送方和接收方用来实现可靠数据传输服务。
* 16比特的接收窗口字段，该字段用于流量控制。
* 4比特的首部长度字段，该字段指示了以32比特的字为单位的TCP首部长度。
* 可选与变长的选项字段，该字段用于发送方与接收方协商最大报文段长度（MSS）时，或在高速网络环境下用作窗口调节因子时使用。
* 6比特的标志字段。ACK用于指示一个对已被成功接收报文段的确认。RST、SYN和FIN比特用于连接建立和拆除。当PSH比特被设置的时候，就指示接收方应立即将数据交给上层。URG比特用来指示报文段里存在着被发送端的上层实体置为“紧急”的数据。紧急数据的最后一个字节由16比特的紧急数据指针字段指出。

### 3.5.2.1 序号和确认号
TCP把数据看成一个无结构的、有序的字节流。一个报文段的序号因此是该报文段首字节的字节流编号。一个报文段的确认号指示的是该报文段的发送方期望接收到的字节流的起始编号，这表示发送方已接收到该确认号指示的字节流之前的全部字节。因为TCP只确认字节流中至第一个丢失字节为止的字节，所以TCP被称为提供累计确认。<br>
### 3.5.2.2 Telnet：序号和确认号的一个学习案例

## 3.5.3 往返时间的估计与超时
TCP采用超时/重传机制来处理报文段的丢失问题。<br>
### 3.5.3.1 估计往返时间
报文段的样本RTT（表示为SampleRTT）就是从某报文段被发出（即交给IP）到对该报文段的确认被收到之间的时间量。大多数TCP的实现仅在某个时刻做一次SampleRTT测量，而不是为每个发送的报文段测量一个SampleRTT。另外，TCP决不为已被重传的报文段计算SampleRTT。<br>

由于路由器的拥塞和端系统负载的变化，这些报文段的SampleRTT值会随之波动。因此TCP维持一个SampleRTT均值（称为EstimatedRTT），一旦获得一个新SampleRTT时，TCP就会根据下列公式来更新EstimatedRTT：
```
EstimatedRTT = (1 - α) * EstimatedRTT + α * SampleRTT
（α参考值为0.125）
```
即EstimatedRTT的新值是由以前的EstimatedRTT值与SampleRTT新值加权组合而成的。从统计学观点讲，这种平均被称为指数加权移动平均（EWMA）。在EWMA中的“指数”一次看起来是指一个给定的SampleRTT的权值在更新的过程中呈指数型快速衰减。<br>

除了估算RTT外，测量RTT的变化也是有价值的。DevRTT用于估算SampleRTT一般会偏离EstimatedRTT的程度：
```
DevRTT = (1 - β) * DevRTT + β * |SampleRTT - EstimatedRTT|
```
DevRTT是一个SampleRTT与EstimatedRTT之间差值的EWMA。如果SampleRTT值波动较小，那么DevRTT的值就会很小，如果波动很大，DevRTT的值就会很大。β的推荐值为0.25.<br>
### 3.5.3.2 设置和管理重传超时间隔
TCP的重传超时间隔为：
```
TimeoutInterval = EstimatedRTT + 4 * DevRTT
```
推荐的初始TimeoutInterval值为1秒。当报文段收到并更新EstimatedRTT后，TimeoutInterval就会使用上述公式重新计算。<br>

## 3.5.4 可靠数据传输
TCP在IP不可靠的尽力而为服务之上创建了一种可靠数据传输服务。TCP的可靠数据传输服务确保一个进程从其接收缓存中读出的数据流是无损坏、无间隔、非冗余和按序的数据流。<br>

## 3.5.5 流量控制
TCP为它的应用程序提供了流量控制服务以消除发送方使接收方缓存溢出的可能性。流量控制因此是一个速度匹配服务，即发送方的发送速率与接收方应用程序的读取速率相匹配。TCP发送方也可能因为IP网络的拥塞而被遏制，这种形式的发送方的控制被称为拥塞控制。它们是针对完全不同的原因而采取的措施。<br>

TCP通过让发送方维护一个称为接收窗口rwnd的变量来提供流量控制。即接收窗口用于给发送方一个指示——该接收方还有多少可用的缓存空间。<br>

## 3.5.6 TCP连接管理
客户中的TCP会用以下方式与服务器中的TCP建立一条TCP连接：
* 第一步：客户端的TCP首先向服务器端的TCP发送一个特殊的TCP报文段。该报文段中不包含应用层数据。但是在报文段的首部中的一个标志位SYN被置为1.因此，这个特殊报文段被称为SYN报文段。另外，客户端会随机地选择一个初始序号（client_isn），并将次编号放置于该起始的TCP SYN报文段的序号字段中。该报文段会被封装在一个IP数据报中，并发送给服务器。
* 第二步：当包含TCP SYN报文段的IP数据报到达服务器主机，服务器从该数据报中提取出TCP SYN报文段，为该TCP连接分配TCP缓存和变量，并向该客户TCP发送允许连接的报文段。该报文段也不包含应用层数据。在该报文段，SYN位被置为1，首部的确认号字段被置为client_isn + 1，并且，服务器选择自己的初始序号（server_isn），并将其放置到TCP报文段首部的序号字段中。该允许连接的报文段被称为SYNACK报文段。
* 第三步：客户端收到SYNACK报文段后，也为该连接分配缓存和变量。客户主机向服务器发送另一个报文段，该报文段对服务器的允许连接的报文段进行了确认，确认号字段为server_isn + 1。SYN位被置为0。可以在这次发送的报文段负载中携带客户到服务器的数据。

参与一条TCP连接的两个进程中的任何一个都能终止该进程，假设客户打算关闭连接：
1. 客户应用进程TCP向服务器进程发送一个TCP报文段，该报文段的标志位FIN被置为1
2. 当服务器接收到该报文段，向发送发回送一个确认报文段。
3. 服务器发送它自己的终止报文段，其FIN位被置为1
4. 客户对服务器的终止报文段发送确认报文段。

# 3.6 拥塞控制原理

## 3.6.2 拥塞控制方法
* 端到端拥塞控制。在端到端拥塞控制方法中，网络层没有为运输层拥塞控制提供显式支持。即端系统是通过对网络行为对观察（如分组丢失与时延）来推断之。
* 网络辅助的拥塞控制。在网络辅助的拥塞控制中，网络层构件（即路由器）向发送方提供关于网络中拥塞状态的显式反馈信息。

# 3.7 TCP拥塞控制
TCP必须使用端到端拥塞控制而不是使用网络辅助的拥塞控制，因为IP层不向端系统提供显式的网络拥塞反馈。<br>

TCP所采用的方法是让每一个发送方根据所感知到的网络拥塞程度来限制其能向连接发送流量的速率。<br>

TCP拥塞控制算法包括3个主要部分：慢启动，拥塞避免，快速恢复。慢启动和拥塞避免是TCP的强制部分，两者的差异在于对收到的ACK做出反应时增加拥塞窗口cwnd长度的方式，快速启动对发送方不是必需的。<br>

## 3.7.1 慢启动
当一条TCP连接开始时，cwnd的值通常初始置为一个MSS的较小值，这就使得初始发送速率大约为MSS/RTT。由于对TCP发送方而言，可用带宽可能比MSS/RTT大得多，TCP发送方希望迅速找到可用带宽的数量。因此，在慢启动状态，每当传输的报文段被确认，就将cwnd的值翻倍，这样，TCP发送速率起始慢，但以指数增长。<br>

如果存在一个由超时指示的丢包时间（即拥塞），TCP发送方将cwnd设置为1并重新开始慢启动过程。它还将第二个状态变量的值ssthresh（“慢启动阙值”的速记）设置为cwnd/2，即当检测到拥塞时将ssthresh置为拥塞窗口值的一半。<br>

慢启动结束的第二种方式是直接与ssthresh的值相关联。因为当监测到拥塞时ssthresh设为cwnd值的一半，当达到或超过ssthresh的值时，继续使cwnd翻番有些鲁莽。因此，当cwnd的值等于ssthresh时，结束慢启动并且TCP转移到拥塞避免模式。此时，TCP更为谨慎地增加cwnd。<br>

最后一种结束慢启动地方式是，如果检测到3个冗余ACK，这时TCP执行一种快速重传并进入快速恢复状态。<br>

## 3.7.2 拥塞避免
一旦进入拥塞避免状态，cwnd的值大约是上次遇到拥塞时的值的一半。此时，TCP无法每过一个RTT再将cwnd的值翻番，而是采用一种较为保守的方法，每个RTT只将cwnd的值增加一个MSS。<br>

当出现超时时，TCP的拥塞避免算法行为相同。与慢启动的情况一样，cwnd的值被设置为1个MSS，当丢包事件出现时，ssthresh的值被更新为cwnd值的一半。当一个三个冗余ACK事件发生时，网络继续从发送方向接收方交付报文段。因此TCP对这种丢包事件的行为，相比于超时指示的丢包，应当不那么强烈：TCP将cwnd的值减半（为使测量结果更好，计及已收到的3个冗余的ACK要加上3个MSS），并且当收到3个冗余的ACK，将ssthresh的值记录为cwnd的值的一半。接下来进入快速恢复状态。<br>

## 3.7.3 快速恢复
在快速恢复中，对于引起TCP进入快速恢复状态的缺失报文段，对收到的每个冗余的ACK，cwnd的值增加一个MSS。最终，当对丢失报文段的一个ACK到达时，TCP在降低cwnd后进入拥塞避免状态。如果出现超时事件，快速恢复在执行如同在慢启动和拥塞避免中相同的动作后，迁移到慢启动状态：当丢包事件出现时，cwnd的值被设置为1个MSS，并且ssthresh的值设置为cwnd值的一半。<br>