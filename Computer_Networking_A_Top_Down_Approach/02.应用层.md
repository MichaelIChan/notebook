# 2.2 Web 和 HTTP
## 2.2.1 HTTP 概况
`Web`的应用层协议是超文本传输协议（HyperText Transfer Protocol, HTTP），它是`web`的核心。`HTTP`由两个程序实现：一个客户程序和一个服务器程序。它们通过交换`HTTP`报文进行会话。`HTTP`定义了这些报文的结构以及客户和服务器进行报文交换的方式。<br>

`HTTP`使用`TCP`作为它的支撑运输协议。`HTTP`客户首先发起一个与服务器的`TCP`连接。一旦连接建立，该浏览器和服务器进程就可以通过套接字接口访问`TCP`。<br>

服务器向客户发送被请求的文件，而不存储关于该客户的任何信息，所以我们说`HTTP`是一个无状态协议。<br>
## 2.2.2 非持续连接和持续连接
在因特网应用程序中，客户端和服务器将在一个相当长的时间范围里通信，其中客户发出一系列请求并且服务器对每个请求进行响应。应用程序将根据自身的特点，选择以规则的间隔周期性地发出请求也可以间断性地一个个发出请求。当这种客户-服务器的交互是经`TCP`进行时，应用程序的开发者就需要做出一个决定，即每个请求/响应是经一个单独的`TCP`连接发送，还是所有的请求及其响应经相同的`TCP`发送。采用前一种方法，该应用程序被称为使用非持续连接；采用后一种方法，该应用程序被称为使用持续连接。`HTTP`既能够使用持续连接也能够使用非持续连接，`HTTP`在默认情况下使用持续连接。<br>
1. 采用非持续连接的 HTTP<br>
   在非持续连接情况下，其中每个`TCP`连接在服务器发送一个对象后关闭，即该连接不为其他的对象而持续下来。每个`TCP`连接只传输一个请求报文和一个响应报文。每个Web页面有多少个对象就需要多少个`TCP`连接。当客户向服务器发送一个`HTTP`请求时，首先客户向Web服务器发起一个`TCP`连接，这涉及一次“三次握手”过程，即客户向服务器发送一个`TCP`报文段，服务器用一个`TCP`报文段做出确认和响应，客户向服务器返回确认。三次握手中的前两个部分所耗费的时间占用率一个RTT，客户结合第三部分向该`TCP`连接发送一个`HTTP`请求报文。一旦该请求报文到达服务器，服务器就在该TCP连接上发送`HTML`文件。因此，粗略的讲，总的响应时间是两个RTT加上服务器传输`HTML`文件的时间。<br>
2. 采用持续连接的 HTTP<br>
   在采用持续连接的情况下，服务器在发送响应后保持该`TCP`连接打开。在相同的客户与服务器之间的后续请求和响应报文能够通过相同的连接进行传送。一般来说，如果一条连接经过一定时间间隔仍未被使用，`HTTP`服务器就关闭该连接。<br>
## 2.2.3 HTTP 报文格式
`HTTP`报文有两种：请求报文和响应报文。<br>
### 2.2.3.1 HTTP 请求报文
下面是一个典型的`HTTP`请求报文：<br>
```
GET /somedir/page.html HTTP/1.1
Host: www.somschool.edu
Connection: close
User-agent: Mozilla/5.0
Accept-language: fr
```
`HTTP`请求报文的第一行叫做请求行，其后继的行叫做首部行。<br>

请求行有3个字段：方法字段、`URL`字段和`HTTP`版本字段。方法字段可以取`GET`、`POST`、`HEAD`、`PUT`和`DELETE`。绝大部分的`HTTP`请求报文使用`GET`方法。当浏览器请求一个对象时，使用`GET`方法，在`URL`字段带有请求对象的标识。<br>

首部行`Host`指明了对象所在的主机，该首部行提供的信息是Web代理高速缓冲所要求的。通过包含`Connection: close`首部行，该浏览器高速服务器不希望使用持续连接，它要求服务器在发送完被请求的对象后就关闭这条连接。`User-agent`首部行用来指明用户代理，即向服务器发送请求的浏览器的类型。`Accept-language`首部行表示用户想得到该对象的语言版本。<br>

首部行（和附加的回车和换行）后有一个“实体行”。使用`GET`方法时实体为空，而使用`POST`方法时才使用该实体。当用户提交表单时，`HTTP`客户常常使用`POST`方法。但用表单生成的请求报文不是必须使用`POST`方法，`HTTP`表单经常使用GET方法，并在（表单字段中）所请求的`URL`中包括输入的数据。<br>

`HEAD`方法类似于`GET`方法，当服务器收到使用`HEAD`方法的请求时，将会用一个`HTTP`报文进行响应，但是并不返回请求对象。`PUT`方法常与Web发行工具联合使用，它允许用户上传对象到指定的Web服务器上指定的路径，也被那些需要想Web服务器上传对象的应用程序使用。`DELETE`方法允许用户或者应用程序删除Web服务器上的对象。<br>
### 2.2.3.2 HTTP 响应报文
下面是一个典型的`HTTP`响应报文：<br>
```
HTTP/1.1 200 OK
Connection: close
Date: Tue, 09 Aug 2011 15:44:04 GMT
Server: Apache/2.2.3 (CentOS)
Last-Modified: Tue, 09 Aug 2011 15:11:03 GMT
Content-Length: 6821
Content-Type: text/html

(data data data data data ...)
```
这个响应报文有三个部分：一个初始状态行，6个首部行，然后是实体体。实体体是报文的主要部分，即它包含了所请求的对象本身。状态行有3个字段：协议版本字段、状态码和相应状态信息。<br>

服务器用`Connection: close`首部行告诉客户，发送完报文后将关闭该`TCP`连接。`Date`首部行指示服务器产生并发送该响应报文的日期和时间。`Server`首部行指示该报文是由一台`Apache Web`服务器产生的。`Last-Modified`首部行指示了对象创建或者最后修改的日期和时间。`Content-Lengt`h首部行指示了被发送对象中的字节数。`Content-Type`首部行指示了实体体中的对象是`HTML`文本。<br>

状态码及其相应的短语指示了请求的结果。一些常见的状态码和相关的短语包括：<br>
* `200 OK`: 请求成功，信息在返回的相应报文中。
* `301 Moved Permanently`: 请求的对象已经被永久转移了，新的`URL`定义在响应报文的`Location`首部行中。客户软件将自动获取新的URL。
* `400 Bad Request`: 一个通用差错代码，指示该请求不能被服务器理解。
* `404 Not Found`: 被请求的文档不在服务器上。
* `505 HTTP Version Not Supported`: 服务器不支持请求报文使用的`HTTP`协议版本。
* `304 Not Modified`: 当使用条件GET方法，Web缓存器向Web服务器发送一个条件GET执行最新检查，如果在Web服务器中由If-Modified-Since首部行指定的时间点后没有修改该对象，那么返回该状态码，它告诉缓存器可以使用该对象，能向请求的浏览器转发该对象的副本。

### 2.2.4 用户与服务器的交互：cookie
一个Web站点通常希望能够识别用户，可能是因为服务器希望限制用户的访问，或者因为它希望把内容与用户身份联系起来。为此`HTTP`使用了`cookie`，它允许站点对用户进行跟踪。<br>

`cookie`技术有4个组件：
1. 在`HTTP`响应报文中的一个`cookie`首部行；
2. 在`HTTP`请求报文中的一个`cookie`首部行；
3. 在用户端系统中保留有一个`cookie`文件，由用户的浏览器进行管理；
4. 位于Web站点的一个后端数据库。

`cookie`可以用于标识一个用户。用户首次访问一个站点时，可能需要提供一个用户标识，在后续会话中，浏览器向服务器传递一个`cookie`首部，从而向该服务器标识了用户。因此`cookie`可以在无状态的`HTTP`之上建立一个用户会话层。<br>

### 2.2.5 Web 缓存
Web缓存也叫代理服务器，能够代表初始Web服务器来满足`HTTP`请求的网络实体。Web缓存器有自己的磁盘存储空间，并在存储空间中保存最近请求过的对象的副本。可以配置用户的浏览器，使得用户的所有`HTTP`请求首先指向Web缓存器。一旦某浏览器被配置，每个对某对象的浏览器请求首先被定向到该Web缓存器。<br>
当浏览器请求对象，将会发生如下情况：
* 浏览器建立一个到Web缓存器的`TCP`连接，并向Web缓存器中的对象发送一个`HTTP`请求。
* Web缓存器进行检查，看看本地是否存储了该对象副本。如果有，Web缓存器就向客户浏览器用`HTTP`响应报文返回该对象。
* 如果Web缓存器中没有该对象，它就打开一个与该对象的初始服务器的`TCP`连接。Web缓存器则在这个缓存器到服务器的`TCP`连接上发送一个对该对象的`HTTP`请求。在收到该请求后，初始服务器向该Web缓存器发送具有该对象的`HTTP`响应。
* 当Web缓存器接收到该对象时，它在本地存储空间存储一份副本，并向客户的浏览器用`HTTP`响应报文发送该副本。

Web缓存器是服务器同时又是客户。在因特网上部署Web缓存器有两个原因：首先，Web缓存器可以大大减少对客户请求的响应时间，特别是当客户与初始服务器之间的瓶颈带宽远低于客户与Web缓存器之间的瓶颈带宽时更为如此。其次，Web缓存器能够大大减少一个机构的接入链路到因特网的通信量，因此就降低了费用。<br>

### 2.2.6 条件 GET 方法
尽管高速缓存能减少用户感受到的响应时间，但也引入了一个新问题，即存放在缓存器中的对象副本可能是陈旧的。`HTTP`协议有一种机制，允许缓存器证实它的对象是最新的。这种机制就是条件`GET`方法。如果，请求报文使用`GET`方法，并且请求报文中包含一个`“If-Modified-Since”`首部行，那么这个`HTTP`请求就是一个条件`GET`请求报文。<br>

作为对条件`GET`方法的响应，Web服务器仍发送一个响应报文。如果响应报文状态行中为`304 Not Modified`，它告诉缓存器可以使用该对象，能向请求的浏览器转发它（该代理缓存器）缓存的该对象副本。<br>